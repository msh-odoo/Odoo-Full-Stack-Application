<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- ================================================================== -->
        <!-- PORTAL RECORD RULES: Access Control for Portal Users -->
        <!-- ================================================================== -->
        <!--
        Portal Security Pattern
        
        PRINCIPLE:
        Portal users should only access their own records.
        Internal users have full access to all records.
        
        RULE STRUCTURE:
        - domain_force: SQL WHERE clause condition
        - [('partner_id', '=', user.partner_id.id)]: Match current user's partner
        - groups: Which groups this rule applies to
        
        GROUPS:
        - base.group_portal: Portal users (customers)
        - base.group_user: Internal users (employees)
        - base.group_public: Public/anonymous users
        
        NOUPDATE:
        - noupdate="1": Don't update on module upgrade
        - Allows customization without overwriting
        - Can be manually modified in production
        -->
        
        <!-- ============================================================== -->
        <!-- BOOKING PORTAL RULES -->
        <!-- ============================================================== -->
        
        <!-- Portal Rule: Users can only see their own bookings -->
        <record id="service_booking_rule_portal" model="ir.rule">
            <field name="name">Portal User: Own Bookings Only</field>
            <field name="model_id" ref="service_event_base.model_service_booking"/>
            <field name="domain_force">[('partner_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!--
        RULE BREAKDOWN:
        ===============
        - name: Human-readable rule description
        - model_id: Which model this rule applies to
        - domain_force: Filter condition
          * [('partner_id', '=', user.partner_id.id)]
          * "partner_id" field on booking must match current user's partner
        - groups: Only apply to portal users (base.group_portal)
        - perm_read: Can read (True)
        - perm_write: Cannot modify (False)
        - perm_create: Cannot create (False)
        - perm_unlink: Cannot delete (False)
        
        RESULT:
        Portal users can only:
        - READ their own bookings
        - Cannot modify, create, or delete
        
        SECURITY NOTES:
        - Always use user.partner_id.id (current user's partner)
        - Never hardcode IDs in domain_force
        - Test with actual portal user, not admin
        - Verify partner_id is set on all bookings
        -->
        
        <!-- ============================================================== -->
        <!-- EVENT PORTAL RULES -->
        <!-- ============================================================== -->
        
        <!-- Portal Rule: Users can see all published events -->
        <record id="service_event_rule_portal" model="ir.rule">
            <field name="name">Portal User: Published Events Only</field>
            <field name="model_id" ref="service_event_base.model_service_event"/>
            <field name="domain_force">[('state', '=', 'published')]</field>
            <field name="groups" eval="[(4, ref('base.group_portal')), (4, ref('base.group_public'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!--
        RULE BREAKDOWN:
        ===============
        - domain_force: [('state', '=', 'published')]
          * Only show published events
          * Hides draft events from portal/public users
        - groups: Portal AND Public users
          * Both logged-in portal users and anonymous visitors
        - perm_read: True (can view)
        - All other permissions: False
        
        RESULT:
        Portal and public users can:
        - READ published events only
        - Cannot see draft/cancelled events
        - Cannot modify events
        
        BUSINESS LOGIC:
        - Events must be published to be visible
        - Protects draft/internal events
        - Allows event browsing before login
        -->
        
        <!-- ============================================================== -->
        <!-- PUBLIC ACCESS RULES -->
        <!-- ============================================================== -->
        
        <!-- Public Rule: Anonymous users can browse published events -->
        <record id="service_event_rule_public" model="ir.rule">
            <field name="name">Public User: Browse Published Events</field>
            <field name="model_id" ref="service_event_base.model_service_event"/>
            <field name="domain_force">[('state', '=', 'published')]</field>
            <field name="groups" eval="[(4, ref('base.group_public'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!--
        WHY TWO EVENT RULES?
        ====================
        1. service_event_rule_portal: For portal users
        2. service_event_rule_public: For anonymous users
        
        While they have the same domain, they target different groups.
        This is a common Odoo pattern for clarity and maintainability.
        
        ALTERNATIVE:
        Could combine into one rule with both groups, but separate
        rules allow for future differentiation (e.g., portal users
        might see more details).
        -->
        
    </data>
</odoo>
